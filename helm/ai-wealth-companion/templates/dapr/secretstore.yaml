{{- if .Values.dapr.enabled }}
# Phase V: Dapr Secret Store Component (Kubernetes Secrets)
# AI Wealth Companion Secrets Management
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: {{ .Values.dapr.secretstore.name | default "secretstore" }}
  namespace: {{ .Values.global.namespace }}
  labels:
    app.kubernetes.io/name: dapr-secretstore
    app.kubernetes.io/component: secrets-management
    app.kubernetes.io/part-of: ai-wealth-companion
spec:
  type: {{ .Values.dapr.secretstore.type | default "secretstores.kubernetes" }}
  version: v1
  metadata: []

  # Scopes - which apps can use this component
  scopes:
    - backend
    - mcp-server
    - frontend
---
# Dapr Configuration for the namespace
apiVersion: dapr.io/v1alpha1
kind: Configuration
metadata:
  name: ai-wealth-config
  namespace: {{ .Values.global.namespace }}
  labels:
    app.kubernetes.io/name: dapr-config
    app.kubernetes.io/part-of: ai-wealth-companion
spec:
  # Tracing configuration
  tracing:
    samplingRate: "1"
    {{- if .Values.observability.jaeger.enabled }}
    zipkin:
      endpointAddress: "http://jaeger-collector.{{ .Values.global.namespace }}.svc.cluster.local:9411/api/v2/spans"
    {{- end }}

  # Metrics configuration
  metric:
    enabled: true

  # Middleware configuration
  httpPipeline:
    handlers:
      - name: ratelimit
        type: middleware.http.ratelimit
      - name: retry
        type: middleware.http.retry

  # Access control
  accessControl:
    defaultAction: allow
    trustDomain: "ai-wealth"

  # API configuration
  api:
    allowed:
      - name: state
        protocol: http
        version: v1.0
      - name: publish
        protocol: http
        version: v1.0
      - name: subscribe
        protocol: http
        version: v1.0
      - name: secrets
        protocol: http
        version: v1.0
      - name: invoke
        protocol: http
        version: v1.0
---
# Rate Limit Middleware Component
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: ratelimit
  namespace: {{ .Values.global.namespace }}
spec:
  type: middleware.http.ratelimit
  version: v1
  metadata:
    - name: maxRequestsPerSecond
      value: "100"
    - name: key
      value: "client_ip"
---
# Retry Middleware Component
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: retry
  namespace: {{ .Values.global.namespace }}
spec:
  type: middleware.http.retry
  version: v1
  metadata:
    - name: maxRetries
      value: "3"
    - name: perTryTimeout
      value: "5s"
    - name: retryOn
      value: "5xx"
{{- end }}
